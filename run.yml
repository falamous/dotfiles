---
- name: prepare
  hosts: 127.0.0.1
  connection: local
  tasks:
    - name: configure git email
      ini_file:
        path: '/home/{{ username }}/.gitconfig'
        section: user
        option: email
        value: falamous@mail.ru

    - name: configure git username
      ini_file:
        path: '/home/{{ username }}/.gitconfig'
        section: user
        option: name
        value: falamous

    - name: configure git editor
      ini_file:
        path: '/home/{{ username }}/.gitconfig'
        section: core
        option: editor
        value: nvim

    - name: edit pacman.conf
      blockinfile:
        path: /etc/pacman.conf
        block: |
          [options]
          ParallelDownloads = 16
          [multilib]
          Include = /etc/pacman.d/mirrorlist
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
      register: pacman_conf
      become: yes
    - name: pacman -Sy
      pacman:
        update_cache: yes
      when: pacman_conf.changed
      become: yes
    - name: link xinitrc
      file:
        src: '/home/{{username}}/{{ repo_location }}/xinitrc'
        dest: '/home/{{ username }}/.xinitrc'
        state: link
    - name: link Xresources
      file:
        src: '/home/{{username}}/{{ repo_location }}/Xresources'
        dest: '/home/{{ username }}/.Xresources'
        state: link
    - name: link config
      file:
        src: '/home/{{username}}/{{ repo_location }}/config'
        dest: '/home/{{ username }}/.config'
        state: link
    - name: link scripts
      file:
        src: '/home/{{username}}/{{ repo_location }}/scripts'
        dest: '/home/{{ username }}/scripts'
        state: link
    - name: create ~/wq
      file:
        name: '/home/{{ username }}/wq'
        state: directory
    - name: zshenv
      copy:
        content: 'source ~/.config/zsh/zshenv'
        dest: '/home/{{ username }}/.zshenv'
    - name: install yay
      kewlfft.aur.aur:
        name: yay
        state: present
        use: makepkg
    - name: install rsync
      kewlfft.aur.aur:
        name: rsync
        state: present
    # - name: copy ~/ files
    #   synchronize:
    #     src: "{{ home_files_location }}"
    #     dest: "/home/{{ username }}"
    #   become: yes
    # - name: chown ~/ files
    #   file:
    #     path: "/home/{{ username }}"
    #     owner: falamous
    #     recurse: yes
    #   become: yes
    - name: create share/mozilla
      file:
        name: '/home/{{username}}/share/mozilla'
        state: directory
    - name: link mozilla
      file:
        src: '/home/{{username}}/share/mozilla'
        dest: '/home/{{ username }}/.mozilla'
        state: link

- name: install and configure packages
  hosts: 127.0.0.1
  connection: local
  tasks:
    - name: setup timezone
      timezone:
        name: Europe/Moscow
        hwclock: UTC
      become: yes

    - import_tasks: tasks/locale.yml

    - name: xorg
      kewlfft.aur.aur:
        name:
          - xorg
          - xclip
        state: present

    - name: window manager and graphical tools
      kewlfft.aur.aur:
        name:
          - qtile
          - python-xlib
          - picom
          - unclutter
          - dunst
          - light
          - rofi
          - rofi-greenclip
          - flameshot
          - sxiv
          - mpv
          - xwallpaper
          - pinta
          - alacritty
          - xdg-user-dirs
          - xdotool
        state: present

    - name: create ~/downloads
      file:
        name: "/home/{{ username }}/downloads"
        state: directory

    - name: programming languages and libraries
      kewlfft.aur.aur:
        name:
          - nodejs
          - npm
          - yarn
          - php
          - go
          - cuda
          - gcc
          - gtk2
          - sdl
          - clang
          - ruby
          - python2
          - pypy3
        state: present

    - name: create .config/npm
      file:
        name: "/home/{{ username }}/.config/npm"
        state: directory

    - name: edit npmrc
      blockinfile:
        path: "/home/{{ username }}/.config/npm/pmrc"
        block: |
          prefix=${XDG_DATA_HOME}/npm
          cache=${XDG_CACHE_HOME}/npm
          tmp=${XDG_RUNTIME_DIR}/npm
          init-module=${XDG_CONFIG_HOME}/npm/npm-init.js
        marker: "// {mark} ANSIBLE MANAGED BLOCK"
        create: yes

    - import_tasks: tasks/ly.yml

    - import_tasks: tasks/nvim.yml

    - import_tasks: tasks/zsh.yml

    - name: fonts
      kewlfft.aur.aur:
        name:
          - ttf-courier-prime-code
          - adobe-source-code-pro-fonts
          - ttf-nerd-fonts-symbols
          - ttf-symbola
        state: present

    - name: net tools
      kewlfft.aur.aur:
        name:
          - iw
          - wpa_supplicant
          - bind
          - iputils
          - gnu-netcat
          - nmap
          - socat
          - net-tools
          - ntp
          - wireshark-qt
        state: present

    - import_tasks: tasks/gdb.yml

    - name: z3
      kewlfft.aur.aur:
        name:
          - z3
          - python-z3
        state: present

    - name: tesseract
      kewlfft.aur.aur:
        name:
          - tesseract
          - tesseract-data-rus
          - python-pyocr
        state: present

    - name: python and python libs
      kewlfft.aur.aur:
        name:
          - python
          - python-requests
          - python-pip
          - python-gmpy2
          - python-flask
          - python-django
          - python-numpy
          - python-sympy
          - python-psutil
          - ipython
        state: present

    - name: python and python libs
      kewlfft.aur.aur:
        name:
          - wine
          - wine-mono
          - wine-gecko
        state: present
 
    - name: qemu and crosscompiling
      kewlfft.aur.aur:
        name:
          - qemu
          - qemu-arch-extra
          - aarch64-linux-gnu-gcc
          - aarch64-linux-gnu-binutils
        state: present

    - import_tasks: tasks/tabbed.yml
    - import_tasks: tasks/slock.yml

    - name: daemons
      kewlfft.aur.aur:
        name:
          - cronie
          - tor
          - docker
          - docker-compose
        state: present

    - name: enable cronie
      systemd:
        name: cronie
        state: started
        enabled: yes
        masked: no
      become: yes

    - name: cli utilities
      kewlfft.aur.aur:
        name:
          - man
          - man-pages
          - ripgrep
          - lsd
          - zip
          - unzip
          - evtest
          - sqlite
          - sqlitebrowser
          - p7zip
          - wget
          - aria2
          - pv
          - imagemagick
          - mlocate
          - bootiso
        state: present

    - name: create .config/wgetrc
      blockinfile:
        path: '/home/{{ username }}/.config/wgetrc'
        block: "hsts-file = /home/{{ username }}/.cache/wget-hsts"
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        create: yes


    - name: add updatedb to cron
      cron:
        name: update db
        hour: 18
        job: "updatedb"
      become: yes

    - name: reverse and pwn stuff
      kewlfft.aur.aur:
        name:
          - radare2
          - r2ghidra
          - ghidra
          - ropper
          - strace
          - ltrace
          - python-pwntools
          - python-uncompyle6
          - ropper
          - ropgadget
        state: present

    - name: add the user to useful groups
      user:
        name: "{{ username }}"
        groups: 
          - wireshark
          - uucp
          - proc
          - video
          - audio
          - docker
          - input
          - wheel
        append: yes
      become: yes

    - name: install pipewire, extensions and related packages
      kewlfft.aur.aur:
        name:
          - pipewire
          - pipewire-pulse
          - pipewire-alsa
          - pulsemixer
        state: present

    - name: communication apps
      kewlfft.aur.aur:
        name:
          - telegram-desktop
          - discord
          - vk-messenger
        state: present

    - name: copy macgen (mac address randomization script)
      copy:
        src: "scripts/macgen"
        dest: "/bin/macgen"
      become: yes
    - name: copy changemac (mac address change script)
      copy:
        src: "scripts/changemac"
        dest: "/bin/changemac"
      become: yes

    - name: enable mac-randomization script
      cron:
        name: macgen
        day: 13
        job: macgen
      become: yes

    - name: edit root bashrc
      blockinfile:
        path: /root/.bashrc
        block: |
          export EDITOR=nvim
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        create: yes
      become: yes

    - name: edit hwdb (CAPS to escape)
      blockinfile:
        path: /etc/udev/hwdb.d/generic-keyboard.hwdb
        block: |
          evdev:input:*
            KEYBOARD_KEY_70039=esc
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        create: yes
      become: yes

    - name: edit hwdb (laptop keys)
      blockinfile:
        path: /etc/udev/hwdb.d/notebook-keyboard.hwdb
        block: |
          evdev:input:b0003v0B05p1866e0110*
            KEYBOARD_KEY_c00ea=home
            KEYBOARD_KEY_c00e9=end
            KEYBOARD_KEY_7004c=insert
            KEYBOARD_KEY_ff31007c=pageup
            KEYBOARD_KEY_ff310038=pagedown
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        create: yes
      become: yes

    - import_tasks: tasks/asusctl.yml
    - import_tasks: tasks/mpd.yml

    - name: update time
      shell: "ntpdate pool.ntp.org && hwclock -w"
      become: yes

    - name: browsers
      kewlfft.aur.aur:
        name:
          - torbrowser-launcher
          - chromium
          - firefox
          - google-chrome
        state: present

    - import_tasks: tasks/pass.yml

    - name: cleanup .cargo
      file:
        name: '/home/{{ username }}/.cargo'
        state: absent

    - name: cleanup .bash_history
      file:
        name: '/home/{{ username }}/.bash_history'
        state: absent
    # - name: set firefox as default browser 
    #   shell: "firefox --setDefaultBrowser"
